# ADR-002: Финальный статус платежей — по вебхуку; идемпотентность по gateway_payment_id
Статус: Accepted
Дата: 2025-08-22

## Контекст
Страницы success у клиента ненадёжны (закрытая вкладка, сеть). PSP присылают вебхуки.

## Решение
- Финальный статус платежа выставляется только в обработчике валидного вебхука.
- Страницы success/return информативны и делают идемпотентную проверку.
- Идемпотентность: уникальный ключ `payments.gateway_payment_id`.
- В `payments`: поля `webhook_received_at`, `webhook_last_status`.
- Проверка подписей по правилам PSP (YooMoney, Qiwi, Advcash).

## Последствия
+ Консистентность статусов, устойчивость к повторам.
− Нужна надёжная обработка вебхуков и подписи.

## План внедрения
Миграции (уникальный индекс + поля), обработчики вебхуков, e2e-тесты.

## Тест-план
Инициирование → повторные вебхуки → финальный статус один раз.
