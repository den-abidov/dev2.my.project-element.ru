# ADR-000: Домены и зависимости (baseline)
Статус: Accepted
Дата: 2025-08-22
Владельцы: Денис, Команда

## Контекст
Нужно простое и понятное разделение на домены для читабельности, тестируемости и расширяемости.

## Решение
Домены: Registration, Auth, User(+UserStatusPolicy), ReferralSystem, Payment, Subscription, Notification(+Reminders), Admin, Report, Shared.

### Зависимости (правила)
- Registration → Auth, ReferralSystem(read), User(write)
- User → ReferralSystem(read), Subscription(read)
- ReferralSystem — автономен (не знает про PSP)
- Subscription → Payment (интерфейс)
- Payment — автономен; истина по статусам только по вебхукам
- Admin → команды в любых доменах
- Notification, Report — только подписчики на события
- Shared — базовый слой (VO/утилиты), без бизнес-логики

### События (минимальный контракт)
Auth: EmailVerified
Registration: RegistrationCompleted
ReferralSystem: ObligationCreated/Completed/Reassigned, SponsorChainRebuilt
Payment: PaymentInitiated/Completed/Failed
Subscription: SubscriptionExtended/DueSoon/Expired
User: UserStatusChanged
Admin: UserBlocked/UserDeleted, PaymentManuallyAdjusted

### Инварианты
- Финальный статус платежа — только по валидному вебхуку Payment.
- Статус пользователя производный: (а) все обязательства закрыты (ReferralSystem); (б) подписка активна (Subscription).
- Идемпотентность платежей — по gateway_payment_id.

## Последствия
+ Понятные границы, слабая связность.
+ Легко подключать новые PSP.
− Нужны проекторы read-моделей (Report) для быстрой выдачи.

## Тест-план
Контрактные тесты событий, e2e регистрация → обязательства → платеж → статус; нагрузка на «Исходящие переводы».
